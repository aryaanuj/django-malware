{% extends 'core/layout/layout.html' %}
{%load static%}

{% block title %} REPORT {% endblock title %} 

{% block content %} 
  <section class="container-fluid pb-5 mb-5" style="height: auto;">
    <div class="loading" style="display:none;">
      <i class="fa fa-cog fa-spin" style="color:#200080 !important"></i>
      <br><br>
      <p class="loading-txt">SCANNING...</p>
    </div>
    <div class="m-3 pb-3">
      <a href="../../pdf/{{report_hash}}" class="btn btn-primary btn-sm float-right"><i class="fa fa-report"></i>Download Report</a>
    </div>
    <div id="main-cont" >
      </div>
      <!-- tabs section  -->
      <div class="col-md-12" id="analysis-overview">
        <table class='table table-striped text-white'><th style='border-left:10px solid #FFDE2E;'>ANALYSIS OVERVIEW&nbsp;<i class='fa fa-info-circle text-info'></i></th></table>
          <nav>
            <div class="nav nav-tabs" id="nav-tab" role="tablist">
              <a class="nav-item nav-link active text-warning" id="nav-home-tab" data-toggle="tab" href="#nav-home" role="tab" aria-controls="nav-home" aria-selected="true" style="font-size:13px">STRUCTURAL INFORMATION</a>
              <a class="nav-item nav-link text-warning" id="nav-profile-tab" data-toggle="tab" href="#nav-profile" role="tab" aria-controls="nav-profile" aria-selected="false" style="font-size:13px">BEHAVIOURAL INFORMATION</a>
            </div>
          </nav>
          <div class="tab-content" id="nav-tabContent" >
            <div class="tab-pane fade show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab" >
              <table>
                <tbody>
                  <div id="structuralInfo" class="pl-4 pt-3"></div>
                </tbody>
              </table>
            </div>
            <div class="tab-pane fade" id="nav-profile" role="tabpanel" aria-labelledby="nav-profile-tab">
              <table>
                <tbody>
                  <div id="behaviouralInfo" class="pl-4 pt-3"></div>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <!-- tabs section end -->
      </section>
     
    
{% endblock content %}
{%block script%}
  <script type="text/javascript">
      function create_basic_properties_container(result){
          let basic_prop =  `<div id="basic-prop">`;
          basic_prop += `<table class='table table-striped text-white'>`;
          basic_prop += `<th style='border-left:10px solid #FFDE2E;'>
          BASIC PROPERTIES <i class='fa fa-info-circle text-info'></i></th>`;
          basic_prop += `</table>`;
          basic_prop += `<table class='ml-2' style='border:none'>`;
          basic_prop += `<tr>
          <td>Filename</td>
          <td>${result['filename']}</td>
          </tr><tr>
          <td>Filesize</td>
          <td>${result['filesize']}</td>
          </tr><tr>
          <td>Filetype</td>
          <td>${result['filetype']}</td>
          </tr><tr>
          <td>MD5</td>
          <td>${result['md5']}</td>
          </tr><tr>
          <td>SHA-1</td>
          <td>${result['sha1']}</td>
          </tr><tr>
          <td>SHA-256</td>
          <td>${result['sha256']}</td>
          </tr><tr>
          <td>SSDEEP</td>
          <td>${result['ssdeep']}</td>
          </tr><tr>
          <td>Magic</td>
          <td>${result['magic']}</td>
          </tr><tr>
          <td>Scan Result</td>
          <td>${result['scan_result']}</td>
          </tr><tr>
          <td>Malware Type</td>
          <td>${result['malware_type']}</td>
          </tr>
          `;
          basic_prop += `</table></div>`;
          return basic_prop;
        }
   
   function create_section_header_container(section_header_result){
     var section_header_table = `<table class='table table-responsive table-bordered section_header_table text-center'>`;
     section_header_table += `<thead>
     <tr>
     <th>Section Header Name</th>
     <th>Number Of Line Numbers</th>
     <th>Pointer To Relocations</th>
     <th>Characteristics</th>
     <th>Virtual Address</th>
     <th>Virtual Size</th>
     <th>Pointer To Raw Data</th>
     <th>Size Of Raw Data</th>
     <th>Pointer To Line Numbers</th>
     <th>Number Of Relocations</th>
     </tr></thead>`;
     section_header_table += `<tbody>${section_header_result}</tbody></table>`;
     return section_header_table;
   }

   function generate_section_header_result(data){
      let section_header_result = '';
      for(let sec_key in data){
         section_header_result += `<tr>
         <td>${sec_key}</td>
         <td>${data[sec_key]['Number Of Line Numbers']}</td>
         <td>${data[sec_key]['Pointer To Relocations']}</td>
         <td>${data[sec_key]['Characteristics']}</td>
         <td>${data[sec_key]['Virtual Address']}</td>
         <td>${data[sec_key]['Virtual Size']}</td>
         <td>${data[sec_key]['Pointer To Raw Data']}</td>
         <td>${data[sec_key]['Size Of Raw Data']}</td>
         <td>${data[sec_key]['Pointer To Line Numbers']}</td>
         <td>${data[sec_key]['Number Of Relocations']}</td>
         </tr>`;
      }
     return section_header_result;
   }

  $(document).ready(function() {
    var interval = setInterval(function(){
      axios({
          method:"get",
          url: "{{BASE_URL}}analyzed_data/list?uuid={{report_hash}}",
          headers: {'Content-Type': 'application/json;charset=UTF-8','Authorization': 'Bearer {{request.session.API_TOKEN}}'}
        }).then((response) =>{
            response = response.data[0];

            // empty containers
            $("#structuralInfo").empty();
            $("#behaviouralInfo").empty();
            $("#main-cont").empty();

            // check complete status
            if(response.status == 'complete'){
                clearInterval(interval);
            }

            // initialize variables
             var section_header_result='';
             var basic_prop_result = '';
             var structural_info = '';
             var behaviouralInfo = '';

             // create basic property
             basic_prop_result=create_basic_properties_container(response);
             
             // get special header
             for(var key in response.structural_info){
                switch(key){
                  case "Section Header":
                  section_header_result = generate_section_header_result(response.structural_info[key]);
                  section_header_result = create_section_header_container(section_header_result);
                  delete response.structural_info[key];
                  break;
                }
              }

            // Render json views
            structural_info = JsonView.createTree(response['structural_info']);
            JsonView.render(structural_info, document.querySelector('#structuralInfo'));
            JsonView.expandChildren(structural_info);

            behaviouralInfo = JsonView.createTree(response['behavioural_info']);
            JsonView.render(behaviouralInfo, document.querySelector('#behaviouralInfo'));
            JsonView.expandChildren(behaviouralInfo);
            
            // Render normal data view
            $("#main-cont").html(basic_prop_result);
            $("#behaviouralInfo").append(section_header_result);
            
        }).catch(err =>{
            console.log(err);
      });
      }, 1000); //setInterval
    }); //ready document
</script>
{%endblock script%}