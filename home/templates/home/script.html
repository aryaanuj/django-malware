
<script>
// available server
setInterval(function() {
    $.ajax({
      url: "{{BASE_URL}}server",
      headers: {'Content-Type': 'application/json;charset=UTF-8','Authorization': 'Bearer {{request.session.API_TOKEN}}'},
      method: "GET",
      success: function(data) {
      	var output = '';
      	data.forEach((item)=>{
      		output += `<div class="pl-4"><p>${item.server_name}</p>`;
	      	if(item.status === true){
	      		output += `<i class="fa fa-server fa-2x" style="color:#25d366;"></i>`;
	      	}else{
	      		output += `<i class="fa fa-server fa-2x" style="color:red;"></i>`;
	      	}
	  		output += `</div>`;
      	});
        $("#server").html(output);
      }
    });
  },3000);
	function sendFileToServer(formData, status) {
		const file = [...formData];
		var uploadURL = "{{BASE_URL}}analyzed_data/"; //Upload URL
		var extraData = {}; //Extra Data.
		var jqXHR = $.ajax({
			async:true,
			xhr: function() {
				var xhrobj = $.ajaxSettings.xhr();
				if (xhrobj.upload) {
					xhrobj.upload.addEventListener('progress', function(event) {
						var percent = 0;
						var position = event.loaded || event.position;
						var total = event.total;
						if (event.lengthComputable) {
							percent = Math.ceil(position / total * 100);
						}
						//Set progress
						status.setProgress(percent);
					}, false);
				}
			return xhrobj;
		},
		url: uploadURL,
		type: "POST",
		headers: {"X-CSRFToken":file[1][1], 'Authorization': 'Bearer {{request.session.API_TOKEN}}'},
		contentType: false,
		processData: false,
		cache: false,
		data: formData,
		success: function(obj) {
			if (obj.status) {
				status.setProgress(100);
				$("#prog").html("<label>File uploaded successfully</label>");
				$(".statusbar").hide();
				$("#analyzebtn").html("<a href='/home/report/" + obj.uuid + "' class='btn text-white' style='background-color:#200080'>Analyze <i class='fa fa-arrow-right'></i></a>");
				$("#analyzebtn").attr("disabled", false);
			} else {
				$("#file-upload-modal .modal-title").html("Error");
				$("#file-upload-modal .modal-body").html(obj.error);
				$("#file-upload-modal .modal-footer").html("");
				$("#file-upload-modal").modal('show');
			}
		}
	});
	status.setAbort(jqXHR);
}
function getfiletype(file) {
	var extension = file.substr((file.lastIndexOf('.') + 1));
	extension = extension.toLowerCase();
	switch (extension) {
		case 'jpg':
		case 'png':
		case 'gif':
		case 'jpeg':
		$("#imagetype").attr('class', 'fa fa-image fa-5x');
		$(".file-type").html(extension);
		break;
		case 'zip':
		case 'rar':
		$("#imagetype").attr('class', 'fa fa-file-archive-o fa-5x');
		$(".file-type").html(extension);
		break;
		case 'pdf':
		$("#imagetype").attr('class', 'fa fa-file-pdf-o fa-5x');
		$(".file-type").html(extension);
		break;
		case 'mp4':
		case 'mpeg':
		case '3gp':
		$("#imagetype").attr('class', 'fa fa-file-video-o fa-5x');
		$(".file-type").html(extension);
		break;
		case 'mp3':
		$("#imagetype").attr('class', 'fa fa-file-audio-o fa-5x');
		$(".file-type").html(extension);
		break;
		case 'xls':
		case 'csv':
		$("#imagetype").attr('class', 'fa fa-file-excel-o fa-5x');
		$(".file-type").html(extension);
		break;
		case 'docx':
		$("#imagetype").attr('class', 'fa fa-file-word-o fa-5x');
		$(".file-type").html(extension);
		break;
		case 'php':
		case 'js':
		case 'html':
		case 'py':
		$("#imagetype").attr('class', 'fa fa-file-code-o fa-5x');
		$(".file-type").html(extension);
		break;
		default:
		$("#imagetype").attr('class', 'fa fa-file-text-o fa-5x');
		$(".file-type").html(extension);
	}
};
function createStatusbar(obj) {
	obj = $("#prog");
	this.statusbar = $("<div id='progbar-cont' class='col-md-12 statusbar row'></div>");
	this.progressBar = $("<div class='col-md-10 progressBar progress-bar' role='progressbar'><div>").appendTo(this.statusbar);
	this.abort = $("<div class='col-md-2 abort text-danger p' style='cursor:pointer;'><b>X</b>Cancel</div>").appendTo(this.statusbar);
	obj.after(this.statusbar);
	this.setFileNameSize = function(name, size) {
		var sizeStr = "";
		var sizeKB = size / 1024;
		if (parseInt(sizeKB) > 1024) {
			var sizeMB = sizeKB / 1024;
			sizeStr = sizeMB.toFixed(2) + " MB";
		} else {
			sizeStr = sizeKB.toFixed(2) + " KB";
		}
		getfiletype(name);
		// datas['type'] = name.substr( (name.lastIndexOf('.') +1) );
		// datas['filesize']=sizeStr;
		$(".file-name").html(name);
		$(".file-size").html(sizeStr);
	}
	this.setProgress = function(progress) {
		var progressBarWidth = progress * this.progressBar.width() / 100;
		this.progressBar.find('div').animate({
			width: progressBarWidth
		}, 10).html("<span class='text-center'>" + progress + "% </span>");
		if (parseInt(progress) >= 100) {
			this.abort.hide();
		}
	}
	this.setAbort = function(jqxhr) {
		var sb = this.statusbar;
		this.abort.click(function() {
			$("#file-upload-modal").modal('hide');
			$("#analyze-form")[0].reset();
			jqxhr.abort();
			sb.hide();
		});
	}
}
function handleFileUpload(files, obj) {
	var fd = new FormData();
	var token = $("#analyze-form input[name=csrfmiddlewaretoken]").val();
	fd.append('fileurl', files[0], files[0].name);
	fd.append('token', token);
	fd.append('filename', files[0].name);
	fd.append('user', {{request.user.id}});
		var status = new createStatusbar(obj); //Using this we can set progress.
		$(".mime-type").html(files[0].type);
		// datas["mimetype"]=files[0].type;
		// datas['filename']=files[0].name;
		status.setFileNameSize(files[0].name, files[0].size);
		sendFileToServer(fd, status);
	}
	$(document).ready(function() {
		var obj = $(".dragandrophandler");
		var obs = $("#choosefile");
		obs.on('change', function(e) {
			e.preventDefault();
			var files = this.files;
			$("#file-upload-modal").modal('show');
		//We need to send dropped files to Server
		handleFileUpload(files, obs);
	});
		obj.on('dragenter', function(e) {
			e.stopPropagation();
			e.preventDefault();
			$(this).css('border', '2px solid #f0ad4e');
		});
		obj.on('dragover', function(e) {
			e.stopPropagation();
			e.preventDefault();
		});
		obj.on('drop', function(e) {
			$(this).css('border', '2px dashed #f0ad4e');
			e.preventDefault();
			var files = e.originalEvent.dataTransfer.files;
			$("#file-upload-modal").modal('show');
		//We need to send dropped files to Server
		handleFileUpload(files, obj);
	});
	});
</script>
